# HomelabARR Environment Configuration Validation Guide

This document provides validation steps and troubleshooting for HomelabARR environment configurations across different deployment scenarios with updated architecture (React + Node.js on ports 8084/8092).

## Quick Validation Checklist

### 1. Environment File Selection
- [ ] Choose appropriate environment file for your deployment:
  - `.env.development` - Local development
  - `.env.production` - Production deployment
  - `.env.docker` - Docker Compose deployment
  - `.env.test` - Testing environments
- [ ] Copy chosen template to `.env`
- [ ] Customize values for your specific environment

### 2. Platform-Specific Configuration

#### Linux Configuration
```bash
# Check Docker installation and permissions
docker --version
docker ps
groups $USER | grep docker

# Find Docker group ID
getent group docker | cut -d: -f3

# Verify Docker socket permissions
ls -la /var/run/docker.sock

# Test Docker socket access
docker info
```

#### Windows Configuration
```powershell
# Check Docker Desktop status
docker --version
docker ps

# Verify Docker Desktop is running with Linux containers
docker info | findstr "Operating System"

# Note: DOCKER_GID is not applicable on Windows
```

#### macOS Configuration
```bash
# Check Docker Desktop installation
docker --version
docker ps

# Find Docker group ID (if applicable)
dscl . -read /Groups/docker PrimaryGroupID

# Verify Docker Desktop is running
docker info
```

### 3. Required Environment Variables Validation

#### Core Configuration
- [ ] `NODE_ENV` - Set to appropriate environment (development/production/test)
- [ ] `PORT` - Backend server port (default: 3001)
- [ ] `BIND_ADDRESS` - Server bind address (0.0.0.0 for containers)
- [ ] `LOG_LEVEL` - Logging verbosity (debug/info/warn/error)

#### CORS Configuration
- [ ] `CORS_ORIGIN` - **CRITICAL**: Never use `*` in production
  - Development: `*` (wildcard acceptable)
  - Production: `https://your-domain.com` (specific domain required)
  - Multiple domains: `https://app.com,https://admin.com`

#### Docker Configuration
- [ ] `DOCKER_SOCKET` - Platform-specific Docker socket path
  - Linux/macOS: `/var/run/docker.sock`
  - Windows: `//./pipe/docker_engine` (auto-detected)
- [ ] `DOCKER_GID` - **CRITICAL**: Must match host system
  - Linux: Find with `getent group docker | cut -d: -f3`
  - macOS: Usually `20`
  - Windows: Not applicable (ignored)

#### Authentication Configuration
- [ ] `AUTH_ENABLED` - Enable authentication (true for production)
- [ ] `JWT_SECRET` - **CRITICAL**: Change from default in production
  - Generate with: `openssl rand -base64 32`
  - Minimum 32 characters
  - Never use development secrets in production
- [ ] `DEFAULT_ADMIN_PASSWORD` - **CRITICAL**: Change immediately after deployment

### 4. Network Configuration Validation

#### Service URLs
- [ ] `FRONTEND_URL` - Frontend service URL
  - Development: `http://localhost:5173`
  - Container: `http://frontend:5173`
  - Production: `https://your-domain.com`
- [ ] `BACKEND_URL` - Backend service URL
  - Development: `http://localhost:3001`
  - Container: `http://backend:3001`
  - Production: `https://api.your-domain.com`

#### Port Configuration
- [ ] Check port availability:
```bash
# Linux/macOS
netstat -tlnp | grep -E ':(3001|8087|8088)'

# Windows
netstat -an | findstr -E ':(3001|8087|8088)'
```

### 5. Security Validation (Production Only)

#### Critical Security Checks
- [ ] `CORS_ORIGIN` is NOT set to `*`
- [ ] `JWT_SECRET` is changed from default
- [ ] `DEFAULT_ADMIN_PASSWORD` is changed from default
- [ ] `AUTH_ENABLED` is set to `true`
- [ ] `DEBUG_MODE` is set to `false`
- [ ] All logging features are disabled in production
- [ ] HTTPS is used for all service URLs

## Validation Commands

### Environment Detection
```bash
# Check current environment
node -e "console.log('NODE_ENV:', process.env.NODE_ENV || 'undefined')"

# Validate environment file loading
node -e "require('dotenv').config(); console.log('PORT:', process.env.PORT)"
```

### Docker Validation
```bash
# Test Docker connectivity
docker ps

# Check Docker socket permissions
ls -la /var/run/docker.sock

# Verify Docker group membership (Linux)
groups $USER | grep docker

# Test Docker API access
docker info
```

### Network Validation
```bash
# Check port availability
netstat -tlnp | grep :3001

# Test service connectivity
curl http://localhost:3001/health

# Validate CORS configuration (development)
curl -H "Origin: http://localhost:5173" \
     -H "Access-Control-Request-Method: GET" \
     -H "Access-Control-Request-Headers: Content-Type" \
     -X OPTIONS \
     http://localhost:3001/health
```

### Authentication Validation
```bash
# Test authentication endpoint
curl -X POST http://localhost:3001/auth/login \
     -H "Content-Type: application/json" \
     -d '{"username":"admin","password":"admin"}'
```

## Common Configuration Issues

### CORS Issues
**Problem**: Frontend cannot connect to backend
**Symptoms**: CORS errors in browser console
**Solutions**:
- Development: Set `CORS_ORIGIN=*`
- Production: Set `CORS_ORIGIN=https://your-domain.com`
- Verify frontend URL matches CORS origin
- Check for trailing slashes in URLs

### Docker Permission Issues
**Problem**: Cannot connect to Docker socket
**Symptoms**: "Permission denied" or "Cannot connect to Docker daemon"
**Solutions**:
- Linux: Add user to docker group: `sudo usermod -aG docker $USER`
- Verify `DOCKER_GID` matches host system
- Check socket permissions: `ls -la /var/run/docker.sock`
- Restart after group changes

### Port Conflicts
**Problem**: Port already in use
**Symptoms**: "EADDRINUSE" or "Port already in use"
**Solutions**:
- Check port usage: `netstat -tlnp | grep :3001`
- Change `PORT` to available port
- Stop conflicting services
- Use different ports for different environments

### Authentication Issues
**Problem**: Cannot login or token errors
**Symptoms**: 401 Unauthorized or JWT errors
**Solutions**:
- Verify `JWT_SECRET` is set and consistent
- Check `AUTH_ENABLED` setting
- Ensure password is correct
- Verify token expiration settings

## Platform-Specific Troubleshooting

### Linux Troubleshooting
```bash
# Check Docker service status
sudo systemctl status docker

# Start Docker service
sudo systemctl start docker

# Check user permissions
groups $USER

# Fix Docker permissions
sudo usermod -aG docker $USER
newgrp docker

# Verify Docker group ID
getent group docker
```

### Windows Troubleshooting
```powershell
# Check Docker Desktop status
Get-Process "Docker Desktop"

# Restart Docker Desktop
Stop-Process -Name "Docker Desktop" -Force
Start-Process "Docker Desktop"

# Check Windows containers vs Linux containers
docker info | Select-String "Operating System"
```

### macOS Troubleshooting
```bash
# Check Docker Desktop status
ps aux | grep -i docker

# Restart Docker Desktop
osascript -e 'quit app "Docker"'
open -a Docker

# Check Docker group (if applicable)
dscl . -read /Groups/docker
```

## Environment-Specific Validation

### Development Environment
- [ ] `NODE_ENV=development`
- [ ] `CORS_ORIGIN=*`
- [ ] `AUTH_ENABLED=false` (optional)
- [ ] `DEBUG_MODE=true`
- [ ] All logging features enabled
- [ ] Use localhost URLs

### Production Environment
- [ ] `NODE_ENV=production`
- [ ] `CORS_ORIGIN=https://your-domain.com` (specific domain)
- [ ] `AUTH_ENABLED=true`
- [ ] `DEBUG_MODE=false`
- [ ] All logging features disabled
- [ ] Use HTTPS URLs
- [ ] Strong JWT secret
- [ ] Changed admin password

### Docker Compose Environment
- [ ] Appropriate `NODE_ENV` setting
- [ ] `BIND_ADDRESS=0.0.0.0`
- [ ] Service names in URLs (e.g., `http://backend:3001`)
- [ ] Correct `DOCKER_GID` for host system
- [ ] Volume mounts configured
- [ ] Network configuration matches compose file

## Automated Validation Script

Create a validation script to check your configuration:

```bash
#!/bin/bash
# save as validate-env.sh

echo "HomelabARR Environment Validation"
echo "================================="

# Check Node.js
echo "Node.js version: $(node --version)"

# Check environment file
if [ -f .env ]; then
    echo "✓ .env file exists"
else
    echo "✗ .env file missing"
    exit 1
fi

# Load environment
source .env

# Validate required variables
required_vars=("NODE_ENV" "PORT" "CORS_ORIGIN" "DOCKER_SOCKET")
for var in "${required_vars[@]}"; do
    if [ -z "${!var}" ]; then
        echo "✗ $var is not set"
    else
        echo "✓ $var is set to: ${!var}"
    fi
done

# Check Docker
if command -v docker &> /dev/null; then
    echo "✓ Docker is installed"
    if docker ps &> /dev/null; then
        echo "✓ Docker is accessible"
    else
        echo "✗ Docker is not accessible"
    fi
else
    echo "✗ Docker is not installed"
fi

# Check ports
if netstat -tlnp 2>/dev/null | grep -q ":${PORT}"; then
    echo "✗ Port ${PORT} is already in use"
else
    echo "✓ Port ${PORT} is available"
fi

echo "Validation complete"
```

Run with: `chmod +x validate-env.sh && ./validate-env.sh`

## Getting Help

If you encounter issues not covered in this guide:

1. Check the application logs for detailed error messages
2. Verify your platform-specific configuration
3. Test each component individually (Docker, network, authentication)
4. Consult the main documentation for your deployment method
5. Check for known issues in the project repository

Remember: Always prioritize security in production environments by using specific CORS origins, strong secrets, and proper authentication settings.